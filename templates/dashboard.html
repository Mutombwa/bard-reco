{% extends "base.html" %}

{% block content %}
<!-- Welcome Banner -->
<div class="row mb-4">
    <div class="col-12">
        <div class="stats-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <div class="text-white">
                <h2><i class="fas fa-chart-line"></i> Welcome to BARD-RECO Dashboard</h2>
                <p class="mb-0">Professional Bank Account Reconciliation System - Real-time Collaboration & Analytics</p>
                <small><i class="fas fa-clock"></i> Last Updated: <span id="last-update-time">-</span></small>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Statistics Cards -->
    <div class="col-xl-3 col-md-6">
        <div class="stats-card text-center text-primary fade-in">
            <i class="fas fa-users stats-icon"></i>
            <div class="stats-number" id="total-users">-</div>
            <div class="stats-label">Registered Users</div>
            <small class="text-muted">System-wide</small>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="stats-card text-center text-success fade-in" style="animation-delay: 0.1s;">
            <i class="fas fa-clipboard-list stats-icon"></i>
            <div class="stats-number" id="active-sessions">-</div>
            <div class="stats-label">Active Sessions</div>
            <small class="text-muted">Currently running</small>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="stats-card text-center text-warning fade-in" style="animation-delay: 0.2s;">
            <i class="fas fa-exchange-alt stats-icon"></i>
            <div class="stats-number" id="total-transactions">-</div>
            <div class="stats-label">Total Transactions</div>
            <small class="text-muted">All time</small>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="stats-card text-center text-info fade-in" style="animation-delay: 0.3s;">
            <i class="fas fa-clock stats-icon"></i>
            <div class="stats-number" id="pending-approvals">-</div>
            <div class="stats-label">Pending Review</div>
            <small class="text-muted">Awaiting action</small>
        </div>
    </div>
</div>

<!-- Detailed Statistics Row -->
<div class="row">
    <div class="col-xl-3 col-md-6">
        <div class="stats-card text-center text-success fade-in" style="animation-delay: 0.4s;">
            <i class="fas fa-check-circle stats-icon"></i>
            <div class="stats-number" id="matched-count">-</div>
            <div class="stats-label">Matched</div>
            <small class="text-muted">Successfully reconciled</small>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="stats-card text-center text-danger fade-in" style="animation-delay: 0.5s;">
            <i class="fas fa-exclamation-triangle stats-icon"></i>
            <div class="stats-number" id="unmatched-count">-</div>
            <div class="stats-label">Unmatched</div>
            <small class="text-muted">Requires attention</small>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="stats-card text-center text-primary fade-in" style="animation-delay: 0.6s;">
            <i class="fas fa-globe stats-icon"></i>
            <div class="stats-number" id="foreign-credits">-</div>
            <div class="stats-label">Foreign Credits</div>
            <small class="text-muted">International transactions</small>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="stats-card text-center text-warning fade-in" style="animation-delay: 0.7s;">
            <i class="fas fa-percentage stats-icon"></i>
            <div class="stats-number" id="match-rate">-</div>
            <div class="stats-label">Match Rate</div>
            <small class="text-muted">Overall accuracy</small>
        </div>
    </div>
</div>

<div class="row">
    <!-- Charts -->
    <div class="col-xl-8">
        <div class="chart-container">
            <h5><i class="fas fa-chart-bar"></i> Transaction Analytics</h5>
            <canvas id="transactionChart"></canvas>
        </div>
    </div>
    <div class="col-xl-4">
        <div class="chart-container">
            <h5><i class="fas fa-chart-pie"></i> Session Status</h5>
            <canvas id="statusChart"></canvas>
        </div>
    </div>
</div>

<div class="row">
    <!-- Recent Sessions -->
    <div class="col-xl-6">
        <div class="table-container">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5><i class="fas fa-history"></i> Recent Sessions</h5>
                <button class="btn btn-primary btn-sm" onclick="refreshData()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="sessions-table">
                        <tr>
                            <td colspan="5" class="text-center">
                                <i class="fas fa-spinner fa-spin"></i> Loading...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Recent Transactions -->
    <div class="col-xl-6">
        <div class="table-container">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5><i class="fas fa-exchange-alt"></i> Recent Transactions</h5>
                <div>
                    <button class="btn btn-success btn-sm me-2" onclick="exportData('excel')">
                        <i class="fas fa-file-excel"></i> Excel
                    </button>
                    <button class="btn btn-info btn-sm" onclick="exportData('csv')">
                        <i class="fas fa-file-csv"></i> CSV
                    </button>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-hover table-sm">
                    <thead class="table-dark">
                        <tr>
                            <th>Type</th>
                            <th>Reference</th>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>Date</th>
                            <th>Confidence</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="transactions-table">
                        <tr>
                            <td colspan="8" class="text-center">
                                <i class="fas fa-spinner fa-spin"></i> Loading...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Notifications -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" id="notifications-container">
</div>
{% endblock %}

{% block scripts %}
<script>
// Initialize Socket.IO
const socket = io();

// Initialize charts
let transactionChart, statusChart;

// Connect to WebSocket
socket.on('connect', function() {
    console.log('Connected to BARD-RECO Dashboard');
    socket.emit('request_update');
});

// Handle data updates
socket.on('data_update', function(data) {
    updateStats(data.stats);
    updateSessions(data.sessions);
    updateTransactions(data.transactions);
    updateCharts(data.stats);
});

// Handle new session notifications
socket.on('new_session', function(data) {
    showNotification('New Session Created', `Session ${data.session_id} with ${data.transaction_count} transactions`, 'success');
    socket.emit('request_update'); // Refresh data
});

// Handle user login/logout notifications
socket.on('user_login', function(data) {
    showNotification('User Login', `${data.username} (${data.role}) logged in`, 'info');
});

socket.on('user_logout', function(data) {
    showNotification('User Logout', `${data.username} logged out`, 'info');
});

// Update statistics
function updateStats(stats) {
    // Basic stats
    document.getElementById('total-users').textContent = stats.total_users || 0;
    document.getElementById('active-sessions').textContent = Object.values(stats.sessions_by_status || {}).reduce((a, b) => a + b, 0);
    
    // Transaction counts
    const transactions = stats.transactions_by_type || {};
    const totalTransactions = Object.values(transactions).reduce((a, b) => a + b, 0);
    document.getElementById('total-transactions').textContent = totalTransactions.toLocaleString();
    
    // Status-based stats
    const statuses = stats.transactions_by_status || {};
    document.getElementById('pending-approvals').textContent = (statuses.pending || 0) + (statuses.needs_attention || 0);
    
    // Detailed stats
    document.getElementById('matched-count').textContent = (transactions.matched || 0).toLocaleString();
    const unmatchedCount = (transactions.unmatched_ledger || 0) + (transactions.unmatched_statement || 0);
    document.getElementById('unmatched-count').textContent = unmatchedCount.toLocaleString();
    document.getElementById('foreign-credits').textContent = (transactions.foreign_credit || 0).toLocaleString();
    
    // Calculate and display match rate
    const matchRate = totalTransactions > 0 
        ? ((transactions.matched || 0) / totalTransactions * 100).toFixed(1) 
        : 0;
    document.getElementById('match-rate').textContent = matchRate + '%';
    
    // Update last update time
    document.getElementById('last-update-time').textContent = new Date().toLocaleTimeString();
}

// Update sessions table
function updateSessions(sessions) {
    const tbody = document.getElementById('sessions-table');
    if (sessions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted"><i class="fas fa-inbox"></i><br>No sessions found<br><small>Sessions will appear here once reconciliation data is posted</small></td></tr>';
        return;
    }
    
    // Sort sessions by created_at descending (newest first)
    sessions.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
    
    tbody.innerHTML = sessions.slice(0, 10).map((session, index) => {
        const sessionId = session.id || session.session_id || 'N/A';
        const workflow = session.workflow_type || 'Unknown';
        const status = session.status || 'unknown';
        const created = session.created_at ? new Date(session.created_at).toLocaleString() : 'N/A';
        const totalTrans = session.total_transactions || 0;
        const matched = session.matched_transactions || 0;
        const matchPercentage = totalTrans > 0 ? ((matched / totalTrans) * 100).toFixed(0) : 0;
        
        return `
        <tr class="fade-in" style="animation-delay: ${index * 0.05}s;">
            <td><strong>#${String(sessionId).substring(0, 8)}</strong></td>
            <td>
                <i class="fas fa-${workflow.toLowerCase().includes('bidvest') ? 'building' : workflow.toLowerCase().includes('fnb') ? 'university' : 'cog'}"></i> 
                ${workflow}
                ${totalTrans > 0 ? `<br><small class="text-muted">${totalTrans} transactions</small>` : ''}
            </td>
            <td>
                <span class="status-badge status-${status}">${status.replace('_', ' ')}</span>
                ${totalTrans > 0 ? `<br><small class="text-success">${matchPercentage}% matched</small>` : ''}
            </td>
            <td><small>${created}</small></td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="viewSession('${sessionId}')" title="View Details">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-outline-success" onclick="exportSession('${sessionId}')" title="Export">
                    <i class="fas fa-download"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteSession('${sessionId}')" title="Delete Session">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>
    `;
    }).join('');
}

// Update transactions table
function updateTransactions(transactions) {
    const tbody = document.getElementById('transactions-table');
    if (!transactions || transactions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted"><i class="fas fa-file-invoice"></i><br>No transactions found<br><small>Transactions will appear here once reconciliation completes</small></td></tr>';
        return;
    }
    
    // Sort transactions by created_at descending (newest first) - handle various date formats
    transactions.sort((a, b) => {
        const dateA = a.created_at || a.timestamp || a.date || 0;
        const dateB = b.created_at || b.timestamp || b.date || 0;
        return new Date(dateB) - new Date(dateA);
    });
    
    tbody.innerHTML = transactions.slice(0, 15).map((transaction, index) => {
        // Parse metadata if stored as JSON string
        let metadata = transaction.original_data || {};
        if (typeof metadata === 'string') {
            try {
                metadata = JSON.parse(metadata);
            } catch(e) {
                metadata = {};
            }
        }
        
        // Flexible field mapping - adapt to various data structures
        const type = transaction.transaction_type || transaction.type || transaction.match_type || 'unknown';
        const amount = parseFloat(transaction.amount || transaction.value || transaction.debit || transaction.credit || 0);
        const status = transaction.status || transaction.state || 'pending';
        const created = transaction.created_at || transaction.timestamp || transaction.date;
        const createdDate = created ? new Date(created).toLocaleString() : 'N/A';
        const reference = transaction.reference || transaction.ref || transaction.ledger_reference || transaction.statement_reference || 'N/A';
        
        // Get description from metadata
        const description = metadata.description || transaction.description || 'N/A';
        
        // Get date from metadata
        const txDate = metadata.date || transaction.date || 'N/A';
        
        // Get confidence
        const confidence = transaction.match_confidence || transaction.confidence || metadata.confidence || transaction.match_score;
        const confidencePercent = confidence ? (confidence > 1 ? confidence : confidence * 100).toFixed(0) : null;
        
        // Icon based on transaction type
        let icon = 'exchange-alt';
        let iconColor = 'text-primary';
        let typeDisplay = type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        
        if (type.includes('matched') && !type.includes('unmatched')) {
            icon = 'check-circle';
            iconColor = 'text-success';
        } else if (type.includes('unmatched')) {
            icon = 'exclamation-circle';
            iconColor = 'text-danger';
        } else if (type.includes('foreign')) {
            icon = 'globe';
            iconColor = 'text-info';
            typeDisplay = 'Foreign Credit';
        } else if (type.includes('split')) {
            icon = 'code-branch';
            iconColor = 'text-warning';
            typeDisplay = 'Split Match';
        }
        
        return `
        <tr class="fade-in" style="animation-delay: ${index * 0.03}s;">
            <td>
                <i class="fas fa-${icon} ${iconColor}"></i> 
                <strong>${typeDisplay}</strong>
            </td>
            <td><small class="text-muted">${reference.substring(0, 25)}</small></td>
            <td style="max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${description}">
                <small>${description.substring(0, 40)}</small>
            </td>
            <td>
                <strong ${amount < 0 ? 'class="text-danger"' : 'class="text-success"'}>
                    ${amount < 0 ? '-' : ''}$${Math.abs(amount).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                </strong>
            </td>
            <td><small>${txDate}</small></td>
            <td>
                ${confidencePercent ? `<span class="badge bg-${confidencePercent >= 95 ? 'success' : confidencePercent >= 80 ? 'warning' : 'danger'}">${confidencePercent}%</span>` : '<span class="badge bg-secondary">N/A</span>'}
            </td>
            <td><span class="status-badge status-${status}">${status.replace('_', ' ')}</span></td>
            <td>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteTransaction(${transaction.id})" title="Delete Transaction">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>
    `;
    }).join('');
}

// Update charts
function updateCharts(stats) {
    // Transaction Chart - Enhanced with better labels
    if (transactionChart) {
        transactionChart.destroy();
    }
    
    const transactionCtx = document.getElementById('transactionChart').getContext('2d');
    const transactionData = stats.transactions_by_type || {};
    
    // Format labels for better readability
    const labels = Object.keys(transactionData).map(key => 
        key.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ')
    );
    const values = Object.values(transactionData);
    
    transactionChart = new Chart(transactionCtx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Transaction Count',
                data: values,
                backgroundColor: [
                    'rgba(16, 185, 129, 0.8)',  // Matched - Green
                    'rgba(239, 68, 68, 0.8)',   // Unmatched Ledger - Red
                    'rgba(245, 158, 11, 0.8)',  // Unmatched Statement - Orange
                    'rgba(59, 130, 246, 0.8)',  // Foreign Credit - Blue
                    'rgba(139, 92, 246, 0.8)'   // Split Match - Purple
                ],
                borderColor: [
                    'rgb(16, 185, 129)',
                    'rgb(239, 68, 68)',
                    'rgb(245, 158, 11)',
                    'rgb(59, 130, 246)',
                    'rgb(139, 92, 246)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: true,
                    text: 'Transaction Distribution by Type',
                    font: {
                        size: 14,
                        weight: 'bold'
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = values.reduce((a, b) => a + b, 0);
                            const percentage = total > 0 ? ((context.parsed.y / total) * 100).toFixed(1) : 0;
                            return `${context.parsed.y.toLocaleString()} (${percentage}%)`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString();
                        }
                    },
                    title: {
                        display: true,
                        text: 'Number of Transactions'
                    }
                }
            }
        }
    });
    
    // Status Chart - Enhanced with better styling
    if (statusChart) {
        statusChart.destroy();
    }
    
    const statusCtx = document.getElementById('statusChart').getContext('2d');
    const statusData = stats.sessions_by_status || {};
    
    const statusLabels = Object.keys(statusData).map(key => 
        key.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ')
    );
    const statusValues = Object.values(statusData);
    
    statusChart = new Chart(statusCtx, {
        type: 'doughnut',
        data: {
            labels: statusLabels,
            datasets: [{
                data: statusValues,
                backgroundColor: [
                    'rgba(16, 185, 129, 0.9)',   // Active - Green
                    'rgba(245, 158, 11, 0.9)',   // Under Review - Orange
                    'rgba(59, 130, 246, 0.9)',   // Approved - Blue
                    'rgba(239, 68, 68, 0.9)',    // Rejected - Red
                    'rgba(107, 114, 128, 0.9)'   // Archived - Gray
                ],
                borderWidth: 2,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        font: {
                            size: 12
                        }
                    }
                },
                title: {
                    display: true,
                    text: 'Session Status Breakdown',
                    font: {
                        size: 14,
                        weight: 'bold'
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = statusValues.reduce((a, b) => a + b, 0);
                            const percentage = total > 0 ? ((context.parsed / total) * 100).toFixed(1) : 0;
                            return `${context.label}: ${context.parsed} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

// Utility functions
function refreshData() {
    socket.emit('request_update');
    showNotification('Data Refreshed', 'Dashboard data has been updated', 'success');
    
    // Visual feedback - animate refresh button
    const refreshBtn = event.target.closest('button');
    if (refreshBtn) {
        const icon = refreshBtn.querySelector('i');
        icon.classList.add('fa-spin');
        setTimeout(() => icon.classList.remove('fa-spin'), 1000);
    }
}

function viewSession(sessionId) {
    // For now, show session details in modal or new tab
    showNotification('Session Details', `Viewing session ${sessionId}`, 'info');
    // TODO: Implement detailed session view
    console.log('View session:', sessionId);
}

function deleteSession(sessionId) {
    if (!confirm('Are you sure you want to delete this session and ALL its transactions?\n\nThis action cannot be undone!')) {
        return;
    }
    
    fetch(`/api/delete_session/${sessionId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Session Deleted', `Session ${sessionId.substring(0, 8)} was deleted successfully`, 'success');
            // Refresh data
            socket.emit('request_update');
        } else {
            showNotification('Delete Failed', data.error || 'Failed to delete session', 'danger');
        }
    })
    .catch(error => {
        console.error('Delete error:', error);
        showNotification('Error', 'Failed to delete session: ' + error.message, 'danger');
    });
}

function deleteTransaction(transactionId) {
    if (!confirm('Are you sure you want to delete this transaction?\n\nThis action cannot be undone!')) {
        return;
    }
    
    fetch(`/api/delete_transaction/${transactionId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Transaction Deleted', 'Transaction was deleted successfully', 'success');
            // Refresh data
            socket.emit('request_update');
        } else {
            showNotification('Delete Failed', data.error || 'Failed to delete transaction', 'danger');
        }
    })
    .catch(error => {
        console.error('Delete error:', error);
        showNotification('Error', 'Failed to delete transaction: ' + error.message, 'danger');
    });
}

function exportSession(sessionId) {
    window.open(`/api/export/excel?session_id=${sessionId}`, '_blank');
    showNotification('Export Started', `Exporting session ${sessionId}`, 'success');
}

function exportData(format) {
    window.open(`/api/export/${format}`, '_blank');
    showNotification('Export Started', `Exporting all data in ${format.toUpperCase()} format`, 'info');
}

function showNotification(title, message, type = 'info') {
    const container = document.getElementById('notifications-container');
    const toast = document.createElement('div');
    const timestamp = new Date().toLocaleTimeString();
    
    toast.className = `toast show fade-in`;
    toast.innerHTML = `
        <div class="toast-header bg-${type} text-white">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'info' ? 'info-circle' : 'exclamation-triangle'} me-2"></i>
            <strong class="me-auto">${title}</strong>
            <small>${timestamp}</small>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body">
            ${message}
        </div>
    `;
    
    container.appendChild(toast);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        toast.remove();
    }, 5000);
}

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    // Request initial data
    socket.emit('request_update');
    
    // Set up auto-refresh every 30 seconds
    setInterval(() => {
        socket.emit('request_update');
    }, 30000);
});
</script>
{% endblock %}