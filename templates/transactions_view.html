{% extends "base.html" %}

{% block content %}
<!-- Session Selector -->
<div class="row mb-3">
    <div class="col-12">
        <div class="stats-card">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4><i class="fas fa-exchange-alt"></i> Transaction Details</h4>
                    <p class="mb-0 text-muted">View transactions organized by type - Side-by-side comparison for matched items</p>
                </div>
                <div>
                    <select class="form-select" id="session-selector" onchange="loadSessionTransactions(this.value)">
                        <option value="all">All Sessions</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Transaction Type Tabs -->
<ul class="nav nav-tabs nav-fill mb-4" id="transactionTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="matched-tab" data-bs-toggle="tab" data-bs-target="#matched-panel" type="button" role="tab">
            <i class="fas fa-check-circle text-success"></i> Matched <span class="badge bg-success ms-2" id="matched-badge">0</span>
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="foreign-tab" data-bs-toggle="tab" data-bs-target="#foreign-panel" type="button" role="tab">
            <i class="fas fa-globe text-info"></i> Foreign Credits <span class="badge bg-info ms-2" id="foreign-badge">0</span>
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="split-tab" data-bs-toggle="tab" data-bs-target="#split-panel" type="button" role="tab">
            <i class="fas fa-code-branch text-warning"></i> Split <span class="badge bg-warning ms-2" id="split-badge">0</span>
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="fuzzy-tab" data-bs-toggle="tab" data-bs-target="#fuzzy-panel" type="button" role="tab">
            <i class="fas fa-adjust text-primary"></i> Fuzzy Matched <span class="badge bg-primary ms-2" id="fuzzy-badge">0</span>
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="unmatched-stmt-tab" data-bs-toggle="tab" data-bs-target="#unmatched-stmt-panel" type="button" role="tab">
            <i class="fas fa-exclamation-triangle text-orange"></i> Unmatched Statement <span class="badge bg-danger ms-2" id="unmatched-stmt-badge">0</span>
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="unmatched-ledger-tab" data-bs-toggle="tab" data-bs-target="#unmatched-ledger-panel" type="button" role="tab">
            <i class="fas fa-times-circle text-danger"></i> Unmatched Ledger <span class="badge bg-danger ms-2" id="unmatched-ledger-badge">0</span>
        </button>
    </li>
</ul>

<!-- Tab Content -->
<div class="tab-content" id="transactionTabContent">
    <!-- MATCHED TRANSACTIONS - Side by Side -->
    <div class="tab-pane fade show active" id="matched-panel" role="tabpanel">
        <div class="table-container">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5><i class="fas fa-check-double text-success"></i> Matched Transactions (Side-by-Side)</h5>
                <button class="btn btn-success btn-sm" onclick="exportTab('matched')">
                    <i class="fas fa-file-excel"></i> Export
                </button>
            </div>
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead class="table-success">
                        <tr>
                            <th colspan="6" class="text-center">LEDGER ENTRY</th>
                            <th class="text-center" style="background: #90EE90; vertical-align: middle;" rowspan="2">
                                <i class="fas fa-arrows-alt-h"></i>
                            </th>
                            <th colspan="5" class="text-center">STATEMENT ENTRY</th>
                        </tr>
                        <tr>
                            <th>Date</th>
                            <th>Reference</th>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>Balance</th>
                            <th>Confidence</th>
                            <th>Date</th>
                            <th>Reference</th>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>Balance</th>
                        </tr>
                    </thead>
                    <tbody id="matched-tbody">
                        <tr>
                            <td colspan="12" class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin"></i> Loading matched transactions...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- FOREIGN CREDITS - Side by Side -->
    <div class="tab-pane fade" id="foreign-panel" role="tabpanel">
        <div class="table-container">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5><i class="fas fa-globe text-info"></i> Foreign Credits (Side-by-Side)</h5>
                <button class="btn btn-info btn-sm" onclick="exportTab('foreign')">
                    <i class="fas fa-file-excel"></i> Export
                </button>
            </div>
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead class="table-info">
                        <tr>
                            <th colspan="6" class="text-center">LEDGER ENTRY</th>
                            <th class="text-center" style="background: #ADD8E6; vertical-align: middle;" rowspan="2">
                                <i class="fas fa-arrows-alt-h"></i>
                            </th>
                            <th colspan="5" class="text-center">STATEMENT ENTRY</th>
                        </tr>
                        <tr>
                            <th>Date</th>
                            <th>Reference</th>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>Balance</th>
                            <th>Currency</th>
                            <th>Date</th>
                            <th>Reference</th>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>Balance</th>
                        </tr>
                    </thead>
                    <tbody id="foreign-tbody">
                        <tr>
                            <td colspan="12" class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin"></i> Loading foreign credits...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- SPLIT TRANSACTIONS - Side by Side -->
    <div class="tab-pane fade" id="split-panel" role="tabpanel">
        <div class="table-container">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5><i class="fas fa-code-branch text-warning"></i> Split Transactions (Side-by-Side)</h5>
                <button class="btn btn-warning btn-sm" onclick="exportTab('split')">
                    <i class="fas fa-file-excel"></i> Export
                </button>
            </div>
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead class="table-warning">
                        <tr>
                            <th colspan="6" class="text-center">LEDGER ENTRY</th>
                            <th class="text-center" style="background: #FFD700; vertical-align: middle;" rowspan="2">
                                <i class="fas fa-arrows-alt-h"></i>
                            </th>
                            <th colspan="5" class="text-center">STATEMENT ENTRY</th>
                        </tr>
                        <tr>
                            <th>Date</th>
                            <th>Reference</th>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>Balance</th>
                            <th>Split Info</th>
                            <th>Date</th>
                            <th>Reference</th>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>Balance</th>
                        </tr>
                    </thead>
                    <tbody id="split-tbody">
                        <tr>
                            <td colspan="12" class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin"></i> Loading split transactions...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- FUZZY MATCHED - Side by Side -->
    <div class="tab-pane fade" id="fuzzy-panel" role="tabpanel">
        <div class="table-container">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5><i class="fas fa-adjust text-primary"></i> Fuzzy Matched (80-94% Match)</h5>
                <button class="btn btn-primary btn-sm" onclick="exportTab('fuzzy')">
                    <i class="fas fa-file-excel"></i> Export
                </button>
            </div>
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead class="table-primary">
                        <tr>
                            <th colspan="6" class="text-center">LEDGER ENTRY</th>
                            <th class="text-center" style="background: #ADD8E6; vertical-align: middle;" rowspan="2">
                                <i class="fas fa-arrows-alt-h"></i>
                            </th>
                            <th colspan="5" class="text-center">STATEMENT ENTRY</th>
                        </tr>
                        <tr>
                            <th>Date</th>
                            <th>Reference</th>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>Balance</th>
                            <th>Match Score</th>
                            <th>Date</th>
                            <th>Reference</th>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>Balance</th>
                        </tr>
                    </thead>
                    <tbody id="fuzzy-tbody">
                        <tr>
                            <td colspan="12" class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin"></i> Loading fuzzy matches...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- UNMATCHED STATEMENT - Single Column -->
    <div class="tab-pane fade" id="unmatched-stmt-panel" role="tabpanel">
        <div class="table-container">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5><i class="fas fa-exclamation-triangle text-orange"></i> Unmatched Statement Entries</h5>
                <button class="btn btn-danger btn-sm" onclick="exportTab('unmatched_statement')">
                    <i class="fas fa-file-excel"></i> Export
                </button>
            </div>
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead class="table-danger">
                        <tr>
                            <th>Date</th>
                            <th>Reference</th>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>Balance</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="unmatched-stmt-tbody">
                        <tr>
                            <td colspan="7" class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin"></i> Loading unmatched statement entries...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- UNMATCHED LEDGER - Single Column -->
    <div class="tab-pane fade" id="unmatched-ledger-panel" role="tabpanel">
        <div class="table-container">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5><i class="fas fa-times-circle text-danger"></i> Unmatched Ledger Entries</h5>
                <button class="btn btn-danger btn-sm" onclick="exportTab('unmatched_ledger')">
                    <i class="fas fa-file-excel"></i> Export
                </button>
            </div>
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead class="table-danger">
                        <tr>
                            <th>Date</th>
                            <th>Reference</th>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>Balance</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="unmatched-ledger-tbody">
                        <tr>
                            <td colspan="7" class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin"></i> Loading unmatched ledger entries...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const socket = io();

let currentSessionId = 'all';
let allTransactions = [];

// Connect and load initial data
socket.on('connect', function() {
    console.log('Connected to transaction viewer');
    loadSessions();
    socket.emit('request_update');
});

// Handle data updates
socket.on('data_update', function(data) {
    allTransactions = data.transactions || [];
    updateTransactionViews();
});

// Load sessions for selector
function loadSessions() {
    fetch('/api/sessions')
        .then(response => response.json())
        .then(data => {
            const selector = document.getElementById('session-selector');
            selector.innerHTML = '<option value="all">All Sessions</option>';
            
            if (data.sessions) {
                data.sessions.forEach(session => {
                    const option = document.createElement('option');
                    option.value = session.id || session.session_id;
                    option.textContent = `#${String(session.id).substring(0, 8)} - ${session.workflow_type} (${session.total_transactions || 0} trans)`;
                    selector.appendChild(option);
                });
            }
        });
}

// Load transactions for specific session
function loadSessionTransactions(sessionId) {
    currentSessionId = sessionId;
    
    if (sessionId === 'all') {
        socket.emit('request_update');
    } else {
        fetch(`/api/session/${sessionId}/transactions`)
            .then(response => response.json())
            .then(data => {
                allTransactions = data.transactions || [];
                updateTransactionViews();
            });
    }
}

// Update all transaction views
function updateTransactionViews() {
    // Group transactions by type
    const grouped = {
        matched: [],
        foreign_credit: [],
        split_match: [],
        fuzzy: [],
        unmatched_statement: [],
        unmatched_ledger: []
    };
    
    allTransactions.forEach(trans => {
        const type = trans.transaction_type || trans.type || 'unknown';
        const confidence = trans.match_confidence || trans.confidence || (trans.original_data?.confidence) || 0;
        const confPercent = confidence > 1 ? confidence : confidence * 100;
        
        if (type === 'matched') {
            if (confPercent >= 95) {
                grouped.matched.push(trans);
            } else if (confPercent >= 80) {
                grouped.fuzzy.push(trans);
            }
        } else if (type === 'foreign_credit') {
            grouped.foreign_credit.push(trans);
        } else if (type === 'split_match') {
            grouped.split_match.push(trans);
        } else if (type === 'unmatched_statement') {
            grouped.unmatched_statement.push(trans);
        } else if (type === 'unmatched_ledger') {
            grouped.unmatched_ledger.push(trans);
        }
    });
    
    // Update badges
    document.getElementById('matched-badge').textContent = grouped.matched.length;
    document.getElementById('foreign-badge').textContent = grouped.foreign_credit.length;
    document.getElementById('split-badge').textContent = grouped.split_match.length;
    document.getElementById('fuzzy-badge').textContent = grouped.fuzzy.length;
    document.getElementById('unmatched-stmt-badge').textContent = grouped.unmatched_statement.length;
    document.getElementById('unmatched-ledger-badge').textContent = grouped.unmatched_ledger.length;
    
    // Update tables
    renderSideBySide('matched-tbody', grouped.matched, 'matched');
    renderSideBySide('foreign-tbody', grouped.foreign_credit, 'foreign');
    renderSideBySide('split-tbody', grouped.split_match, 'split');
    renderSideBySide('fuzzy-tbody', grouped.fuzzy, 'fuzzy');
    renderUnmatched('unmatched-stmt-tbody', grouped.unmatched_statement);
    renderUnmatched('unmatched-ledger-tbody', grouped.unmatched_ledger);
}

// Render side-by-side transactions (matched, foreign, split, fuzzy)
function renderSideBySide(tbodyId, transactions, type) {
    const tbody = document.getElementById(tbodyId);
    
    if (transactions.length === 0) {
        tbody.innerHTML = `<tr><td colspan="12" class="text-center text-muted"><i class="fas fa-inbox"></i> No ${type} transactions found</td></tr>`;
        return;
    }
    
    tbody.innerHTML = transactions.map((trans, index) => {
        // ✅ FIXED: Parse metadata with nested statement_data and ledger_data
        let metadata = trans.original_data || {};
        if (typeof metadata === 'string') {
            try {
                metadata = JSON.loads(metadata);
            } catch(e) {
                metadata = {};
            }
        }
        
        // Extract nested data structures (NEW STRUCTURE from reconciliation)
        const ledgerData = metadata.ledger_data || {};
        const stmtData = metadata.statement_data || {};
        
        // Ledger side (left) - Extract from ledger_data with dynamic column names
        const ledgerDate = ledgerData.Date || ledgerData.date || metadata.date || 'N/A';
        const ledgerRef = ledgerData['Payment Ref'] || ledgerData.Reference || ledgerData.reference || trans.reference || 'N/A';
        const ledgerDesc = ledgerData.Comment || ledgerData.Description || ledgerData.description || metadata.description || 'N/A';
        const ledgerDebits = parseFloat(ledgerData.Debits || ledgerData.debits || 0);
        const ledgerCredits = parseFloat(ledgerData.Credits || ledgerData.credits || 0);
        const ledgerAmount = Math.abs(ledgerDebits || ledgerCredits || parseFloat(trans.amount || 0));
        const ledgerBalance = ledgerData.Balance || ledgerData.balance || metadata.balance || '—';
        
        // Statement side (right) - Extract from statement_data with dynamic column names
        const stmtDate = stmtData.Date || stmtData.date || metadata.date || ledgerDate;
        const stmtRef = stmtData.Reference || stmtData.reference || trans.reference || ledgerRef;
        const stmtDesc = stmtData.Description || stmtData.description || metadata.description || ledgerDesc;
        const stmtAmount = Math.abs(parseFloat(stmtData.Amount || stmtData.amount || trans.amount || ledgerAmount));
        const stmtBalance = stmtData.Balance || stmtData.balance || metadata.balance || '—';
        
        // Additional info column
        let extraInfo = '';
        if (type === 'matched' || type === 'fuzzy') {
            const confidence = trans.match_confidence || metadata.confidence || metadata.similarity || 0;
            const confPercent = confidence > 1 ? confidence : confidence * 100;
            extraInfo = `<span class="badge bg-${confPercent >= 95 ? 'success' : 'warning'}">${confPercent.toFixed(0)}%</span>`;
        } else if (type === 'foreign') {
            extraInfo = ledgerData.Currency || stmtData.Currency || metadata.currency || 'USD';
        } else if (type === 'split') {
            extraInfo = `<small class="text-muted">Split: ${metadata.split_count || '?'} parts</small>`;
        }
        
        return `
            <tr class="fade-in" style="animation-delay: ${index * 0.02}s;">
                <!-- Ledger Side -->
                <td><small>${ledgerDate}</small></td>
                <td><small class="text-muted">${String(ledgerRef).substring(0, 20)}</small></td>
                <td style="max-width: 200px;" title="${ledgerDesc}"><small>${String(ledgerDesc).substring(0, 40)}...</small></td>
                <td><strong class="text-success">$${ledgerAmount.toLocaleString('en-US', {minimumFractionDigits: 2})}</strong></td>
                <td><small>${ledgerBalance}</small></td>
                <td>${extraInfo}</td>
                
                <!-- Separator -->
                <td class="text-center bg-light">
                    <i class="fas fa-arrows-alt-h text-muted"></i>
                </td>
                
                <!-- Statement Side -->
                <td><small>${stmtDate}</small></td>
                <td><small class="text-muted">${String(stmtRef).substring(0, 20)}</small></td>
                <td style="max-width: 200px;" title="${stmtDesc}"><small>${String(stmtDesc).substring(0, 40)}...</small></td>
                <td><strong class="text-success">$${stmtAmount.toLocaleString('en-US', {minimumFractionDigits: 2})}</strong></td>
                <td><small>${stmtBalance}</small></td>
            </tr>
        `;
    }).join('');
}

// Render unmatched transactions (single column)
function renderUnmatched(tbodyId, transactions) {
    const tbody = document.getElementById(tbodyId);
    
    if (transactions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted"><i class="fas fa-inbox"></i> No unmatched transactions found</td></tr>';
        return;
    }
    
    tbody.innerHTML = transactions.map((trans, index) => {
        // Parse metadata
        let metadata = trans.original_data || {};
        if (typeof metadata === 'string') {
            try {
                metadata = JSON.loads(metadata);
            } catch(e) {
                metadata = {};
            }
        }
        
        const date = metadata.date || trans.date || 'N/A';
        const ref = trans.reference || 'N/A';
        const desc = metadata.description || trans.description || 'N/A';
        const amount = parseFloat(trans.amount || 0);
        const balance = metadata.balance || '—';
        const status = trans.status || 'pending';
        
        return `
            <tr class="fade-in" style="animation-delay: ${index * 0.02}s;">
                <td><small>${date}</small></td>
                <td><small class="text-muted">${String(ref).substring(0, 25)}</small></td>
                <td style="max-width: 250px;" title="${desc}"><small>${String(desc).substring(0, 50)}...</small></td>
                <td><strong class="${amount < 0 ? 'text-danger' : 'text-success'}">
                    ${amount < 0 ? '-' : ''}$${Math.abs(amount).toLocaleString('en-US', {minimumFractionDigits: 2})}
                </strong></td>
                <td><small>${balance}</small></td>
                <td><span class="badge bg-warning">${status}</span></td>
                <td>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteTransaction(${trans.id})" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

// Export tab data
function exportTab(type) {
    const sessionParam = currentSessionId !== 'all' ? `&session_id=${currentSessionId}` : '';
    window.open(`/api/export/excel?type=${type}${sessionParam}`, '_blank');
}

// Delete transaction
function deleteTransaction(transactionId) {
    if (!confirm('Delete this transaction?')) return;
    
    fetch(`/api/delete_transaction/${transactionId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            socket.emit('request_update');
            alert('Transaction deleted successfully');
        } else {
            alert('Failed to delete transaction: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Delete error:', error);
        alert('Error deleting transaction');
    });
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    socket.emit('request_update');
});
</script>

<style>
.text-orange {
    color: #ff8c00 !important;
}

.table-orange {
    background-color: #ffe4b5 !important;
}

.fade-in {
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.nav-tabs .nav-link {
    color: #666;
    font-weight: 500;
}

.nav-tabs .nav-link.active {
    font-weight: 700;
}

.nav-tabs .nav-link:hover {
    background-color: #f8f9fa;
}
</style>
{% endblock %}
